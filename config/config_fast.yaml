# ==========================================
# CONFIGURAZIONE FAST - STIMATRIX
# ==========================================
# 
# Config per test rapidi e sviluppo.
# Usa meno trial per hyperparameter tuning (20 vs 150)
# e disabilita modelli secondari.
#
# ‚è±Ô∏è Tempo stimato: ~20 minuti (vs 2-3 ore config normale)
# üìä Performance: Leggermente inferiore al config.yaml
# üéØ Uso: Testing, debug, iterazione veloce
# ==========================================

# Logging Configuration
logging:
  level: ${LOG_LEVEL:-INFO}  # DEBUG | INFO | WARNING | ERROR | CRITICAL
  format: '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
  file: ${LOG_FILE:-'logs/pipeline_fast.log'}
  console: ${LOG_CONSOLE:-true}
  rotate:
    enabled: ${LOG_ROTATE:-false}
    max_bytes: ${LOG_MAX_BYTES:-10485760}
    backup_count: ${LOG_BACKUP_COUNT:-5}

# Execution Configuration
execution:
  steps: ["preprocessing", "training", "evaluation"]  # all | schema | dataset | preprocessing | training | evaluation
  force_reload: true

# Experiment tracking (Weights & Biases)
tracking:
  wandb:
    enabled: ${WANDB_ENABLED:-true}
    project: ${WANDB_PROJECT:-'stimatrix-fast'}
    entity: ${WANDB_ENTITY:-null}
    group: ${WANDB_GROUP:-null}
    tags: ['fast', 'test']
    mode: ${WANDB_MODE:-'online'}  # online | offline | disabled

# Paths Configuration
paths:
  raw_data: ${RAW_DATA_DIR:-'data/raw'}
  preprocessed_data: ${PREPROC_DIR:-'data/preprocessed'}
  schema: ${SCHEMA_PATH:-'schema/db_schema.json'}
  models_dir: ${MODELS_DIR:-'models'}
  raw_filename: 'raw.parquet'
  preprocessed_filename: 'preprocessed.parquet'

# ==========================================
# DATA FILTERS (Optional - Experimental)
# ==========================================
# Filtri applicati al dataset INTERO (prima dello split) per sperimentazione.
# Tutti i filtri sono opzionali (null = no filter).
# Usa per testare modelli specializzati su sottoinsiemi specifici.
data_filters:
  # Anno stipula
  anno_min: 2022  # Anno minimo (null = no limit)
  anno_max: null  # Anno massimo (null = no limit)
  
  # Prezzo (‚Ç¨) - usare con cautela, limita generalizzazione
  prezzo_min: null  # Prezzo minimo (null = no limit)
  prezzo_max: null  # Prezzo massimo (null = no limit)
  
  # Zone OMI da escludere
  zone_escluse:  # Lista zone da escludere (null = tutte incluse)
    - 'E1'
    - 'E2'
    - 'E3'
    - 'R1'
  
  # Tipologie edilizie da escludere
  tipologie_escluse:  # Lista tipologie da escludere (null = tutte incluse)
    - '4'  # Ville

# Database Configuration (se usi step schema/dataset)
database:
  schema_name: null
  selected_aliases: ['A', 'AI', 'PC', 'ISC', 'II', 'PC_OZ', 'OZ', 'OV', 'C1', 'C2']
  custom_aliases:
    attiimmobili_cened1: 'C1'
    attiimmobili_cened2: 'C2'
  use_poi: true
  use_ztl: true
  output_format: 'parquet'  # parquet | csv
  compression: 'snappy'  # snappy | gzip | none

# Target configuration
target:
  column_candidates: ['AI_Prezzo_Ridistribuito']
  transform: 'yeojohnson'  # none | log | log10 | sqrt | boxcox | yeojohnson
  log10_offset: 1.0

# Outlier detection
outliers:
  method: 'ensemble'  # ensemble | iqr | zscore | iso_forest
  z_thresh: 2.5
  iqr_factor: 1.0
  iso_forest_contamination: 0.08
  group_by_col: 'AI_ZonaOmi'
  min_group_size: 20
  fallback_strategy: 'global'  # global | skip

# Missing value imputation
imputation:
  numeric_strategy: 'median'  # median | mean
  categorical_strategy: 'most_frequent'  # most_frequent | constant
  group_by_col: 'AI_ZonaOmi'

# Categorical encoding
encoding: &encoding_defaults
  one_hot_max: 8
  target_encoding_range: [9, 20]
  frequency_encoding_range: [21, 100]
  ordinal_encoding_range: [101, 200]
  drop_above: 200
  
  target_encoder:
    smoothing: 5.0
    min_samples_leaf: 10

# Temporal split configuration
temporal_split:
  year_col: 'A_AnnoStipula'
  month_col: 'A_MeseStipula'
  mode: 'fraction'  # fraction | date
  fraction:
    train: 0.7
    valid: 0.2
  date:
    test_start_year: 2023
    test_start_month: 1

# Numeric coercion configuration
numeric_coercion:
  enabled: true
  threshold: 0.95
  blacklist_globs:
    - '*Id'
    - '*_Id*'
    - 'Foglio*'
    - '*Particella*'
    - '*Subalterno*'
    - '*Sezione*'
    - '*COD*'
    - '*Codice*'
    - 'AI_ZonaOmi'
    - 'OZ_CodiceZona'
    - '*IdCategoriaCatastale*'
    - '*IdTipologiaEdilizia*'
    - '*Repertorio*'
    - 'II_IdIstatZonaCensuaria'
    - 'ISC_Id'

# PCA configuration
pca: &pca_defaults
  enabled: false
  n_components: 0.95
  random_state: 42

# Correlation pruning
correlation: &correlation_defaults
  numeric_threshold: 0.98

# Non-descriptive columns pruning
drop_non_descriptive:
  na_threshold: 0.80

# Feature extraction toggles
feature_extraction:
  geometry: false
  json: false

# Feature pruning - data-driven (~56 colonne)
feature_pruning:
  drop_columns:
    # ID e chiavi esterne (12 colonne)
    - 'A_Id'
    - 'AI_Id'
    - 'AI_IdAtto'
    - 'AI_IdParticellaCatastale'
    - 'AI_IdImmobile'
    - 'PC_Id'
    - 'PC_IdSezioneCensuaria'
    - 'ISC_Id'
    - 'II_IdIstatZonaCensuaria'
    - 'OZ_Id'
    - 'PC_OZ_IdParticella'
    - 'PC_OZ_IdZona'
    
    # Superficie ridondanti (5 colonne)
    - 'AI_SuperficieCalcolata'
    - 'AI_SuperficieVisuraTotale'
    - 'AI_SuperficieVisuraTotaleE'
    - 'AI_SuperficieVisuraTotaleAttuale'
    - 'AI_SuperficieVisuraTotaleEAttuale'
    
    # Indicatori Istat ridondanti (7 colonne)
    - 'II_ST2_B'
    - 'II_ST21'
    - 'II_ST29'
    - 'II_ST31'
    - 'II_ST32'
    - 'II_ST22'
    - 'II_ST26'
    
    # OmiValori ridondanti (4 colonne)
    - 'OV_ValoreMercatoMax_normale'
    - 'OV_ValoreMercatoMax_ottimo'
    - 'OV_ValoreMercatoMin_scadente'
    - 'OV_ValoreMercatoMax_scadente'
    
    # Metadata e colonne tecniche (13 colonne)
    - 'A_Semestre'
    - 'OZ_IdAnnoSemestre'
    - 'A_DataStipula'
    - 'A_DataRegistrazione'
    - 'A_TotaleFabbricati'
    - 'A_TotaleImmobili'
    - 'A_NumeroRepertorio'
    - 'A_IdNotaio'
    - 'PC_PoligonoMetricoSrid'
    - 'PC_PoligonoMetrico'
    - 'AI_IndirizzoGeometry'
    - 'OZ_IdComune'
    - 'A_ImmobiliPrincipaliConSuperficieValorizzata'
    
    # Codici catastali (8 colonne)
    - 'PC_Foglio'
    - 'PC_Particella'
    - 'PC_SezioneUrbana'
    - 'PC_SezioneAmministrativa'
    - 'PC_SezioneAggraria'
    - 'OZ_CodiceZona'
    - 'OZ_DescrizioneZona'
    - 'AI_Subalterno'
    
    # Colonne processate o poco predittive (7 colonne)
    - 'AI_Piano'
    - 'AI_Civico'
    - 'AI_Rendita'
    - 'A_AcquirentiCount'
    - 'A_VenditoriCount'
    - 'A_EtaMediaAcquirenti'
    - 'A_EtaMediaVenditori'
    - 'A_AcquirentiVenditoriStessoCognome'
    - 'A_VenditoriEredita'

# Scaling configuration
scaling: &scaling_defaults
  scaler_type: 'standard'  # standard | minmax | robust
  with_mean: true
  with_std: true

# Winsorization
winsorization: &winsor_defaults
  enabled: true
  lower_quantile: 0.01
  upper_quantile: 0.99

# Profiles
profiles:
  scaled:
    enabled: false
    output_prefix: 'scaled'
    encoding: *encoding_defaults
    winsorization: *winsor_defaults
    scaling: *scaling_defaults
    pca: *pca_defaults
    correlation: *correlation_defaults
  tree:
    enabled: true
    output_prefix: 'tree'
    encoding: *encoding_defaults
    correlation: *correlation_defaults
  catboost:
    enabled: true
    output_prefix: 'catboost'
    correlation: *correlation_defaults

# Diagnostics configuration
diagnostics:
  residual_analysis:
    enabled: true
    by_groups:
      - AI_ZonaOmi
      - AI_IdCategoriaCatastale
      - price_quartile
    save_worst_predictions: true
    top_n_worst: 50
    plots:
      - residual_vs_predicted
      - residual_vs_actual
      - residual_distribution
      - qq_plot
  
  drift_detection:
    enabled: true
    methods:
      - psi
      - ks_test
    alert_threshold: 0.15
    save_report: true

# Uncertainty quantification
uncertainty:
  prediction_intervals:
    enabled: true
    method: 'residual_bootstrap'  # residual_bootstrap | quantile_regression
    n_bootstraps: 100
    confidence_levels: [0.8, 0.9]

# ==========================================
# TRAINING CONFIGURATION (FAST MODE)
# ==========================================
training:
  primary_metric: "neg_mean_absolute_percentage_error"  # neg_mape | r2 | neg_rmse | neg_mae
  report_metrics: ["r2", "rmse", "mse", "mae", "mape"]
  sampler: "auto"  # auto | tpe | random | cmaes
  seed: ${SEED:-42}
  n_jobs_default: ${N_JOBS:--1}
  timeout: ${TRAIN_TIMEOUT:-null}
  trials_base: &trials_base 10
  trials_advanced: &trials_advanced 20
  
  cv_when_no_val:
    enabled: true
    kind: kfold  # kfold | stratified | timeseries
    n_splits: 5
    shuffle: true

  # ==========================================
  # MODELS (FAST MODE - 4 modelli principali)
  # ==========================================
  models:
    # CatBoost
    catboost:
      enabled: true
      profile: catboost
      trials: *trials_advanced
      base_params:
        allow_writing_files: false
        iterations: 800
        verbose: False
      fit_params:
        cat_features: __categorical_indices__
      search_space:
        depth: {type: int, low: 4, high: 7}
        learning_rate: {type: float, low: 0.01, high: 0.12, log: true}
        l2_leaf_reg: {type: float, low: 3.0, high: 30.0}
        bagging_temperature: {type: float, low: 0.0, high: 1.5}
        border_count: {type: int, low: 32, high: 128}
        random_strength: {type: float, low: 0.0, high: 1.0}
        rsm: {type: float, low: 0.5, high: 0.85}
        min_data_in_leaf: {type: int, low: 20, high: 80}
        max_ctr_complexity: {type: int, low: 1, high: 3}

    # XGBoost
    xgboost:
      enabled: true
      profile: tree
      trials: *trials_advanced
      base_params: {}
      fit_params: {}
      search_space:
        n_estimators: {type: int, low: 400, high: 1200}
        max_depth: {type: int, low: 3, high: 6}
        learning_rate: {type: float, low: 0.005, high: 0.05, log: true}
        subsample: {type: float, low: 0.6, high: 0.85}
        colsample_bytree: {type: float, low: 0.6, high: 0.85}
        min_child_weight: {type: float, low: 5.0, high: 20.0}
        reg_alpha: {type: float, low: 0.1, high: 50.0, log: true}
        reg_lambda: {type: float, low: 1.0, high: 100.0, log: true}
        gamma: {type: float, low: 0.0, high: 5.0}

    # LightGBM
    lightgbm:
      enabled: true
      profile: tree
      trials: *trials_advanced
      base_params: {}
      fit_params: {}
      search_space:
        n_estimators: {type: int, low: 400, high: 1200}
        max_depth: {type: categorical, choices: [4, 5, 6]}
        learning_rate: {type: float, low: 0.01, high: 0.08, log: true}
        num_leaves: {type: int, low: 16, high: 40}
        subsample: {type: float, low: 0.65, high: 0.85}
        colsample_bytree: {type: float, low: 0.65, high: 0.85}
        reg_alpha: {type: float, low: 0.1, high: 50.0, log: true}
        reg_lambda: {type: float, low: 1.0, high: 100.0, log: true}
        min_child_samples: {type: int, low: 50, high: 200}
        min_split_gain: {type: float, low: 0.0, high: 0.5}

    # Random Forest
    rf:
      enabled: true
      profile: tree
      trials: *trials_advanced
      base_params: {}
      fit_params: {}
      search_space:
        n_estimators: {type: int, low: 300, high: 1000}
        max_depth: {type: int, low: 6, high: 30}
        min_samples_split: {type: int, low: 10, high: 40}
        min_samples_leaf: {type: int, low: 5, high: 25}
        max_features: {type: categorical, choices: ["sqrt", "log2", null]}
        bootstrap: {type: categorical, choices: [true]}

    # Modelli disabilitati per fast mode
    gbr:
      enabled: false
    hgbt:
      enabled: false
    linear:
      enabled: false
    ridge:
      enabled: false
    lasso:
      enabled: false
    elasticnet:
      enabled: false
    knn:
      enabled: false
    svr:
      enabled: false
    dt:
      enabled: false

  # ==========================================
  # SHAP
  # ==========================================
  shap:
    enabled: true
    sample_size: 500
    max_display: 50
    save_plots: true
    save_values: true

  # ==========================================
  # ENSEMBLE (FAST MODE - solo stacking)
  # ==========================================
  ensembles:
    voting:
      enabled: false
      top_n: 5
      tune_weights: true
    stacking:
      enabled: true
      top_n: 4
      final_estimator: "ridge"  # ridge | lasso | elasticnet | linear
      cv_folds: 5

# ==========================================
# EVALUATION
# ==========================================
evaluation:
  group_metrics:
    enabled: true
    group_by_columns: ['AI_ZonaOmi', 'AI_IdCategoriaCatastale', 'AI_IdTipologiaEdilizia']
    min_group_size: 10
    original_scale: true
    report_metrics: ['r2', 'rmse', 'mse', 'mae', 'mape', 'medae']
    price_band:
      method: 'quantile'  # quantile | equal_width | custom
      quantiles: [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0]
      mape_floor: 1000.0
      merge_small_bins: true
      label_prefix: 'PREZZO_'
